(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{75410:function(){},48628:function(){},31601:function(){},67792:function(){},34977:function(){},75042:function(){},66058:function(e,t,n){Promise.resolve().then(n.bind(n,83701))},83701:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return j}});var a=n(57437),s=n(2265),l=n(50965),r=n(96586);let i=!1;async function c(){if(!i)try{await r.CQI("wasm"),await r.Cd_(),i=!0}catch(e){try{await r.CQI("cpu"),await r.Cd_(),i=!0}catch(e){throw console.warn("TF.js backend init fallback failed",e),e}}}async function o(e,t){let n=new TextEncoder,a=await crypto.subtle.importKey("raw",n.encode(t),{name:"HMAC",hash:"SHA-256"},!1,["sign"]);return Array.from(new Uint8Array(await crypto.subtle.sign("HMAC",a,n.encode(e)))).map(e=>e.toString(16).padStart(2,"0")).join("")}async function d(e,t,n){let a=new Date().toISOString(),s=crypto.randomUUID(),l=[e,t.lengthCm.toFixed(2),t.timestamp.toString(),a,s].join("|");return{inquiryId:e,measurement:t,issuedAt:a,nonce:s,signature:await o(l,n)}}var u=n(80233),m=n(77515),h=n(74109);function x(e){let{onCapture:t,onMeasurementReady:n,referenceFrameWidthRatio:l=.25,enableBlur:r=!0,minLuminance:i=40,minBlurScore:c=2}=e,o=(0,s.useRef)(null),d=(0,s.useRef)(null),x=(0,s.useRef)(null),[p,g]=(0,s.useState)("idle"),[b,f]=(0,s.useState)(null),[v,j]=(0,s.useState)({light:!0,sharp:!0}),y=(0,s.useRef)(0),w=(0,s.useCallback)(()=>{x.current&&(x.current.getTracks().forEach(e=>e.stop()),x.current=null)},[]),N=(0,s.useCallback)(async()=>{f(null),g("idle");try{let e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:1280,height:720},audio:!1});x.current=e,o.current&&(o.current.srcObject=e,await o.current.play()),g("live")}catch(e){f(e instanceof Error?e.message:"無法取得相機"),g("error")}},[]);(0,s.useEffect)(()=>(N(),()=>{w()}),[N,w]);let C=(0,s.useCallback)(()=>{let e=o.current,t=d.current;if(!e||!t||e.readyState<2)return;let n=t.getContext("2d");if(!n)return;t.width=e.videoWidth,t.height=e.videoHeight,n.drawImage(e,0,0);let a=n.getImageData(0,0,t.width,t.height);j({light:function(e){let t=e.data,n=0,a=0;for(let e=0;e<t.length;e+=4)n+=.299*t[e]+.587*t[e+1]+.114*t[e+2],a++;return a>0?n/a:0}(a)>=i,sharp:function(e){let{data:t,width:n,height:a}=e,s=0,l=0;for(let e=1;e<a-1;e+=4)for(let a=1;a<n-1;a+=4){let r=(e*n+a)*4,i=(t[r]+t[r+1]+t[r+2])/3;s+=Math.abs(-((t[((e-1)*n+a)*4]+t[((e-1)*n+a)*4+1]+t[((e-1)*n+a)*4+2])/3)+2*i-(t[((e+1)*n+a)*4]+t[((e+1)*n+a)*4+1]+t[((e+1)*n+a)*4+2])/3),l++}return l>0?s/l:0}(a)>=c})},[i,c]);(0,s.useEffect)(()=>{if("live"!==p)return;let e=setInterval(()=>{Date.now()-y.current<500||(y.current=Date.now(),C())},800);return()=>clearInterval(e)},[p,C]);let E=(0,s.useCallback)(()=>{let e=o.current,n=d.current;if(!e||!n||e.readyState<2)return;let a=n.getContext("2d");if(!a)return;n.width=e.videoWidth,n.height=e.videoHeight,a.drawImage(e,0,0);let s=a.getImageData(0,0,n.width,n.height);null==t||t(s,!0),g("captured")},[t]),k=(0,s.useCallback)(()=>{g("live")},[]),S=640*l,_=72+85.6/53.98*S;return(0,a.jsxs)("div",{className:"flex flex-col items-center gap-4",children:[(0,a.jsxs)("div",{className:"relative overflow-hidden rounded-xl bg-black",style:{width:640,height:480},children:[(0,a.jsx)("video",{ref:o,autoPlay:!0,playsInline:!0,muted:!0,className:"h-full w-full object-cover ".concat(r?"sensitive-blur":""),style:{transform:"scaleX(-1)"}}),(0,a.jsx)("canvas",{ref:d,className:"hidden"}),"live"===p&&(0,a.jsxs)("div",{className:"camera-overlay",children:[(0,a.jsx)("div",{className:"camera-overlay__frame",style:{left:(640-S)/2,top:72,width:S,height:_-72}}),(0,a.jsx)("div",{className:"camera-overlay__hint",style:{left:0,right:0,top:44},children:"請將參考卡片對齊綠色框"}),(0,a.jsx)("div",{className:"camera-overlay__hint",style:{left:0,right:0,bottom:24},children:"對齊後按下「擷取」"})]})]}),"live"===p&&(0,a.jsxs)("div",{className:"flex items-center gap-4 text-sm",children:[(0,a.jsx)("span",{className:v.light?"text-green-600":"text-amber-600",children:v.light?"亮度足夠":"光線不足"}),(0,a.jsx)("span",{className:v.sharp?"text-green-600":"text-amber-600",children:v.sharp?"畫面清晰":"畫面模糊"})]}),"live"===p&&(0,a.jsxs)("button",{type:"button",onClick:E,disabled:!v.light||!v.sharp,className:"inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-6 py-3 text-white transition hover:bg-emerald-700 disabled:opacity-50",children:[(0,a.jsx)(u.Z,{className:"h-5 w-5"}),"擷取"]}),"captured"===p&&(0,a.jsx)("button",{type:"button",onClick:k,className:"rounded-lg border border-slate-300 bg-white px-4 py-2 text-slate-700 hover:bg-slate-50",children:"重新拍攝"}),"error"===p&&(0,a.jsxs)("div",{className:"flex items-center gap-2 rounded-lg bg-red-50 p-4 text-red-800",children:[(0,a.jsx)(m.Z,{className:"h-5 w-5 shrink-0"}),(0,a.jsx)("span",{children:b}),(0,a.jsx)("button",{type:"button",onClick:N,className:"ml-2 rounded bg-red-100 px-3 py-1 text-sm hover:bg-red-200",children:"重試"})]}),"idle"===p&&(0,a.jsxs)("div",{className:"flex items-center gap-2 text-slate-500",children:[(0,a.jsx)(h.Z,{className:"h-5 w-5 animate-spin"}),"正在啟動相機…"]})]})}let p="https://cdn.withpersona.com/dist/persona-v4.8.0.js";var g=n(20500),b=n(15862),f=n(37164),v=n(20357);function j(){let[e,t]=(0,s.useState)("camera"),[n,r]=(0,s.useState)(null),[i,o]=(0,s.useState)(null),[u,m]=(0,s.useState)(null);(0,s.useEffect)(()=>{c().catch(()=>{})},[]);let j=(0,s.useCallback)((e,n)=>{let a=function(e,t){var n;let{width:a,height:s}=e,l=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8.56,[n,a,s,l]=e,r=(Math.hypot(a.x-n.x,a.y-n.y)+Math.hypot(s.x-l.x,s.y-l.y))/2;return r<=0?0:r/t}(function(e,t){let n=.25*e,a=(e-n)/2,s=.15*t,l=85.6/53.98*n;return[{x:a,y:s},{x:a+n,y:s},{x:a+n,y:s+l},{x:a,y:s+l}]}(a,s),8.56);return l<=0?null:(n=.35*s,{lengthCm:l<=0?0:n/l,ppm:l,timestamp:Date.now(),liveCaptured:t})}(e,n);a&&(r(a),t("measure"))},[]),{ready:y,error:w,open:N}=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"sandbox",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},[a,l]=(0,s.useState)(!1),[r,i]=(0,s.useState)(null),c=(0,s.useRef)(null),{onComplete:o,onCancel:d,onError:u}=n,m=(0,s.useCallback)(()=>{c.current&&c.current.open()},[]);return(0,s.useEffect)(()=>{if(!e)return;if(document.querySelector('script[src="'.concat(p,'"]'))){var n;if(null===(n=window.Persona)||void 0===n?void 0:n.Client)try{let n=new window.Persona.Client({templateId:e,environment:t,onReady:()=>l(!0),onComplete:e=>null==o?void 0:o(e),onCancel:e=>null==d?void 0:d(e),onError:e=>{i(String(e)),null==u||u(e)}});c.current=n,l(!0)}catch(e){i(e instanceof Error?e.message:"Persona 初始化失敗")}return}let a=document.createElement("script");return a.src=p,a.async=!0,a.onload=()=>{var n;if(!(null===(n=window.Persona)||void 0===n?void 0:n.Client)){i("Persona SDK 載入失敗");return}try{let n=new window.Persona.Client({templateId:e,environment:t,onReady:()=>{l(!0),i(null)},onComplete:e=>null==o?void 0:o(e),onCancel:e=>null==d?void 0:d(e),onError:e=>{i(String(e)),null==u||u(e)}});c.current=n}catch(e){i(e instanceof Error?e.message:"Persona 初始化失敗"),null==u||u(e)}},a.onerror=()=>{i("Persona 腳本載入失敗")},document.body.appendChild(a),()=>{c.current=null,l(!1)}},[e,t,o,d,u]),{ready:a,error:r,open:m}}(v.env.NEXT_PUBLIC_PERSONA_TEMPLATE_ID||"itmpl_placeholder",v.env.NEXT_PUBLIC_PERSONA_ENV||"sandbox",{onComplete:e=>{let{inquiryId:n}=e;m(n),t("cert")},onError:()=>{}}),C=(0,s.useCallback)(()=>{t("verify"),N()},[N]),E=(0,s.useCallback)(async()=>{if(!u||!n)return;let e=v.env.NEXT_PUBLIC_CERT_SECRET_KEY||"demo-secret-do-not-use-in-production",t=await d(u,n,e);o(t),function(e){let t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download="certification-".concat(e.inquiryId,"-").concat(Date.now(),".json"),a.click(),URL.revokeObjectURL(n)}(t),(0,l.Z)({particleCount:80,spread:60})},[u,n]);return(0,a.jsx)("main",{className:"min-h-screen bg-slate-50 px-4 py-8",children:(0,a.jsxs)("div",{className:"mx-auto max-w-2xl space-y-8",children:[(0,a.jsxs)("header",{className:"text-center",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-slate-900",children:"生物測量與認證系統"}),(0,a.jsx)("p",{className:"mt-2 text-sm text-slate-600",children:"端上測量 \xb7 影像不離裝置 \xb7 身分驗證後取得數位證書"})]}),"camera"===e&&(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-6 shadow-sm",children:[(0,a.jsxs)("h2",{className:"mb-4 flex items-center gap-2 text-lg font-semibold",children:[(0,a.jsx)("span",{children:"步驟 1"})," 相機擷取"]}),(0,a.jsx)("p",{className:"mb-4 text-sm text-slate-600",children:"請將參考卡片對齊綠色框，並確保光線充足、畫面清晰後擷取。"}),(0,a.jsx)(x,{onCapture:j,referenceFrameWidthRatio:.25,enableBlur:!0})]}),"measure"===e&&n&&(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-6 shadow-sm",children:[(0,a.jsxs)("h2",{className:"mb-4 flex items-center gap-2 text-lg font-semibold",children:[(0,a.jsx)("span",{children:"步驟 2"})," 測量結果"]}),(0,a.jsxs)("div",{className:"mb-4 rounded-lg bg-slate-100 p-4",children:[(0,a.jsx)("p",{className:"text-sm text-slate-600",children:"長度（公分）"}),(0,a.jsxs)("p",{className:"text-2xl font-bold text-slate-900",children:[n.lengthCm.toFixed(2)," cm"]}),(0,a.jsxs)("p",{className:"mt-2 text-xs text-slate-500",children:["即時擷取：",n.liveCaptured?"是":"否"," \xb7 PPM：",n.ppm.toFixed(1)]})]}),(0,a.jsxs)("div",{className:"flex gap-3",children:[(0,a.jsx)("button",{type:"button",onClick:()=>t("camera"),className:"rounded-lg border border-slate-300 px-4 py-2 text-sm text-slate-700 hover:bg-slate-50",children:"重新拍攝"}),(0,a.jsx)("button",{type:"button",onClick:C,disabled:!y,className:"inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-4 py-2 text-sm text-white hover:bg-indigo-700 disabled:opacity-50",children:y?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(g.Z,{className:"h-4 w-4"}),"進行身分驗證"]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(h.Z,{className:"h-4 w-4 animate-spin"}),"載入驗證…"]})})]}),w&&(0,a.jsx)("p",{className:"mt-2 text-sm text-amber-600",children:w})]}),"verify"===e&&(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-6 shadow-sm",children:[(0,a.jsxs)("h2",{className:"mb-4 flex items-center gap-2 text-lg font-semibold",children:[(0,a.jsx)("span",{children:"步驟 3"})," 身分驗證 (Persona)"]}),(0,a.jsx)("p",{className:"mb-4 text-sm text-slate-600",children:"請在彈窗中完成政府證件與人臉掃描。完成後將自動進入證書步驟。"}),(0,a.jsx)("button",{type:"button",onClick:N,className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm text-white hover:bg-indigo-700",children:"再次開啟驗證"})]}),"cert"===e&&n&&(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-6 shadow-sm",children:[(0,a.jsxs)("h2",{className:"mb-4 flex items-center gap-2 text-lg font-semibold",children:[(0,a.jsx)("span",{children:"步驟 4"})," 數位證書"]}),u&&(0,a.jsxs)("p",{className:"mb-4 text-sm text-slate-600",children:["身分驗證 ID：",(0,a.jsx)("code",{className:"rounded bg-slate-100 px-1",children:u})]}),(0,a.jsx)("div",{className:"mb-4 rounded-lg bg-emerald-50 p-4",children:(0,a.jsxs)("p",{className:"flex items-center gap-2 text-emerald-800",children:[(0,a.jsx)(b.Z,{className:"h-5 w-5"}),"可下載數位認證證書（含 HMAC-SHA256 簽名）"]})}),(0,a.jsxs)("button",{type:"button",onClick:E,className:"inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700",children:[(0,a.jsx)(f.Z,{className:"h-4 w-4"}),"下載證書 JSON"]})]})]})})}}},function(e){e.O(0,[425,399,663,566,636,938,498,391,971,23,744],function(){return e(e.s=66058)}),_N_E=e.O()}]);