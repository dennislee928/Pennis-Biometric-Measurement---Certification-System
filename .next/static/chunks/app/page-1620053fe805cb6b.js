(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{75410:function(){},48628:function(){},31601:function(){},67792:function(){},34977:function(){},75042:function(){},66058:function(e,t,n){Promise.resolve().then(n.bind(n,22938))},22938:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return N}});var a=n(57437),s=n(2265),r=n(50965),l=n(96586);let i=!1;async function c(){if(!i)try{await l.CQI("wasm"),await l.Cd_(),i=!0}catch(e){try{await l.CQI("cpu"),await l.Cd_(),i=!0}catch(e){throw console.warn("TF.js backend init fallback failed",e),e}}}var o=n(59941),d=n(96264),u=n(48652),h=n(6881),x=n(80233),m=n(77515),f=n(74109);function p(e){let{onCapture:t,onMeasurementReady:n,referenceFrameWidthRatio:r=.25,enableBlur:l=!0,minLuminance:i=40,minBlurScore:c=2}=e,o=(0,s.useRef)(null),d=(0,s.useRef)(null),u=(0,s.useRef)(null),[h,p]=(0,s.useState)("idle"),[b,g]=(0,s.useState)(null),[v,j]=(0,s.useState)({light:!0,sharp:!0}),y=(0,s.useRef)(0),N=(0,s.useCallback)(()=>{u.current&&(u.current.getTracks().forEach(e=>e.stop()),u.current=null)},[]),w=(0,s.useCallback)(async()=>{g(null),p("idle");try{let e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:1280,height:720},audio:!1});u.current=e,o.current&&(o.current.srcObject=e,await o.current.play()),p("live")}catch(e){g(e instanceof Error?e.message:"無法取得相機"),p("error")}},[]);(0,s.useEffect)(()=>(w(),()=>{N()}),[w,N]);let C=(0,s.useCallback)(()=>{let e=o.current,t=d.current;if(!e||!t||e.readyState<2)return;let n=t.getContext("2d");if(!n)return;t.width=e.videoWidth,t.height=e.videoHeight,n.drawImage(e,0,0);let a=n.getImageData(0,0,t.width,t.height);j({light:function(e){let t=e.data,n=0,a=0;for(let e=0;e<t.length;e+=4)n+=.299*t[e]+.587*t[e+1]+.114*t[e+2],a++;return a>0?n/a:0}(a)>=i,sharp:function(e){let{data:t,width:n,height:a}=e,s=0,r=0;for(let e=1;e<a-1;e+=4)for(let a=1;a<n-1;a+=4){let l=(e*n+a)*4,i=(t[l]+t[l+1]+t[l+2])/3;s+=Math.abs(-((t[((e-1)*n+a)*4]+t[((e-1)*n+a)*4+1]+t[((e-1)*n+a)*4+2])/3)+2*i-(t[((e+1)*n+a)*4]+t[((e+1)*n+a)*4+1]+t[((e+1)*n+a)*4+2])/3),r++}return r>0?s/r:0}(a)>=c})},[i,c]);(0,s.useEffect)(()=>{if("live"!==h)return;let e=setInterval(()=>{Date.now()-y.current<500||(y.current=Date.now(),C())},800);return()=>clearInterval(e)},[h,C]);let k=(0,s.useCallback)(()=>{let e=o.current,n=d.current;if(!e||!n||e.readyState<2)return;let a=n.getContext("2d");if(!a)return;n.width=e.videoWidth,n.height=e.videoHeight,a.drawImage(e,0,0);let s=a.getImageData(0,0,n.width,n.height);null==t||t(s,!0),p("captured")},[t]),S=(0,s.useCallback)(()=>{p("live")},[]),E=640*r,_=72+85.6/53.98*E;return(0,a.jsxs)("div",{className:"flex flex-col items-center gap-4",children:[(0,a.jsxs)("div",{className:"relative overflow-hidden rounded-xl bg-black",style:{width:640,height:480},children:[(0,a.jsx)("video",{ref:o,autoPlay:!0,playsInline:!0,muted:!0,className:"h-full w-full object-cover ".concat(l?"sensitive-blur":""),style:{transform:"scaleX(-1)"}}),(0,a.jsx)("canvas",{ref:d,className:"hidden"}),"live"===h&&(0,a.jsxs)("div",{className:"camera-overlay",children:[(0,a.jsx)("div",{className:"camera-overlay__frame",style:{left:(640-E)/2,top:72,width:E,height:_-72}}),(0,a.jsx)("div",{className:"camera-overlay__hint",style:{left:0,right:0,top:44},children:"請將參考卡片對齊綠色框"}),(0,a.jsx)("div",{className:"camera-overlay__hint",style:{left:0,right:0,bottom:24},children:"對齊後按下「擷取」"})]})]}),"live"===h&&(0,a.jsxs)("div",{className:"flex items-center gap-4 text-sm",children:[(0,a.jsx)("span",{className:v.light?"text-green-600":"text-amber-600",children:v.light?"亮度足夠":"光線不足"}),(0,a.jsx)("span",{className:v.sharp?"text-green-600":"text-amber-600",children:v.sharp?"畫面清晰":"畫面模糊"})]}),"live"===h&&(0,a.jsxs)("button",{type:"button",onClick:k,disabled:!v.light||!v.sharp,className:"inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-6 py-3 text-white transition hover:bg-emerald-700 disabled:opacity-50",children:[(0,a.jsx)(x.Z,{className:"h-5 w-5"}),"擷取"]}),"captured"===h&&(0,a.jsx)("button",{type:"button",onClick:S,className:"rounded-lg border border-slate-300 bg-white px-4 py-2 text-slate-700 hover:bg-slate-50",children:"重新拍攝"}),"error"===h&&(0,a.jsxs)("div",{className:"flex items-center gap-2 rounded-lg bg-red-50 p-4 text-red-800",children:[(0,a.jsx)(m.Z,{className:"h-5 w-5 shrink-0"}),(0,a.jsx)("span",{children:b}),(0,a.jsx)("button",{type:"button",onClick:w,className:"ml-2 rounded bg-red-100 px-3 py-1 text-sm hover:bg-red-200",children:"重試"})]}),"idle"===h&&(0,a.jsxs)("div",{className:"flex items-center gap-2 text-slate-500",children:[(0,a.jsx)(f.Z,{className:"h-5 w-5 animate-spin"}),"正在啟動相機…"]})]})}let b="https://cdn.withpersona.com/dist/persona-v4.8.0.js";var g=n(20500),v=n(15862),j=n(37164),y=n(87138);function N(){var e;let[t,n]=(0,s.useState)("camera"),[l,i]=(0,s.useState)(null),[x,m]=(0,s.useState)(null),[N,w]=(0,s.useState)(null);(0,s.useEffect)(()=>{c().catch(()=>{})},[]);let C=(0,s.useCallback)((e,t)=>{let a=function(e,t){var n;let{width:a,height:s}=e,r=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8.56,[n,a,s,r]=e,l=(Math.hypot(a.x-n.x,a.y-n.y)+Math.hypot(s.x-r.x,s.y-r.y))/2;return l<=0?0:l/t}(function(e,t){let n=.25*e,a=(e-n)/2,s=.15*t,r=85.6/53.98*n;return[{x:a,y:s},{x:a+n,y:s},{x:a+n,y:s+r},{x:a,y:s+r}]}(a,s),8.56);return r<=0?null:(n=.35*s,{lengthCm:r<=0?0:n/r,ppm:r,timestamp:Date.now(),liveCaptured:t})}(e,t);a&&(i(a),n("measure"))},[]),{ready:k,error:S,open:E}=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"sandbox",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},[a,r]=(0,s.useState)(!1),[l,i]=(0,s.useState)(null),c=(0,s.useRef)(null),{onComplete:o,onCancel:d,onError:u}=n,h=(0,s.useCallback)(()=>{c.current&&c.current.open()},[]);return(0,s.useEffect)(()=>{if(!e)return;if(document.querySelector('script[src="'.concat(b,'"]'))){var n;if(null===(n=window.Persona)||void 0===n?void 0:n.Client)try{let n=new window.Persona.Client({templateId:e,environment:t,onReady:()=>r(!0),onComplete:e=>null==o?void 0:o(e),onCancel:e=>null==d?void 0:d(e),onError:e=>{i(String(e)),null==u||u(e)}});c.current=n,r(!0)}catch(e){i(e instanceof Error?e.message:"Persona 初始化失敗")}return}let a=document.createElement("script");return a.src=b,a.async=!0,a.onload=()=>{var n;if(!(null===(n=window.Persona)||void 0===n?void 0:n.Client)){i("Persona SDK 載入失敗");return}try{let n=new window.Persona.Client({templateId:e,environment:t,onReady:()=>{r(!0),i(null)},onComplete:e=>null==o?void 0:o(e),onCancel:e=>null==d?void 0:d(e),onError:e=>{i(String(e)),null==u||u(e)}});c.current=n}catch(e){i(e instanceof Error?e.message:"Persona 初始化失敗"),null==u||u(e)}},a.onerror=()=>{i("Persona 腳本載入失敗")},document.body.appendChild(a),()=>{c.current=null,r(!1)}},[e,t,o,d,u]),{ready:a,error:l,open:h}}("itmpl_xxxxxxxx","sandbox",{onComplete:e=>{let{inquiryId:t}=e;w(t),n("cert")},onError:()=>{}}),{session:_,loading:P,accessToken:I}=(0,u.a)(),[R,T]=(0,s.useState)(null),O=(0,s.useCallback)(()=>{n("verify"),E()},[E]),U=(0,s.useCallback)(async()=>{if(N&&l&&I){T(null);try{let e=await (0,d.$F)(I,N,l);m(e),(0,o.cP)(e),(0,r.Z)({particleCount:80,spread:60})}catch(e){T(e instanceof Error?e.message:"簽發失敗")}}},[N,l,I]);return(0,a.jsxs)("main",{className:"min-h-screen bg-slate-50 px-4 py-8",children:[(0,a.jsxs)("nav",{className:"mx-auto mb-6 flex max-w-2xl items-center justify-end gap-4 text-sm",children:[(0,a.jsx)(y.default,{href:"/verify",className:"text-slate-600 hover:text-slate-900",children:"驗證證書"}),(0,a.jsx)(y.default,{href:"/certificates",className:"text-slate-600 hover:text-slate-900",children:"我的證書"}),_?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{className:"text-slate-500",children:null===(e=_.user)||void 0===e?void 0:e.email}),(0,a.jsx)("button",{type:"button",onClick:()=>(0,h.S)().auth.signOut(),className:"text-slate-600 hover:text-slate-900",children:"登出"})]}):(0,a.jsx)(y.default,{href:"/login",className:"rounded bg-slate-800 px-3 py-1.5 text-white hover:bg-slate-700",children:"登入"})]}),(0,a.jsxs)("div",{className:"mx-auto max-w-2xl space-y-8",children:[(0,a.jsxs)("header",{className:"text-center",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-slate-900",children:"生物測量與認證系統"}),(0,a.jsx)("p",{className:"mt-2 text-sm text-slate-600",children:"端上測量 \xb7 影像不離裝置 \xb7 身分驗證後取得數位證書"})]}),"camera"===t&&(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-6 shadow-sm",children:[(0,a.jsxs)("h2",{className:"mb-4 flex items-center gap-2 text-lg font-semibold",children:[(0,a.jsx)("span",{children:"步驟 1"})," 相機擷取"]}),(0,a.jsx)("p",{className:"mb-4 text-sm text-slate-600",children:"請將參考卡片對齊綠色框，並確保光線充足、畫面清晰後擷取。"}),(0,a.jsx)(p,{onCapture:C,referenceFrameWidthRatio:.25,enableBlur:!0})]}),"measure"===t&&l&&(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-6 shadow-sm",children:[(0,a.jsxs)("h2",{className:"mb-4 flex items-center gap-2 text-lg font-semibold",children:[(0,a.jsx)("span",{children:"步驟 2"})," 測量結果"]}),(0,a.jsxs)("div",{className:"mb-4 rounded-lg bg-slate-100 p-4",children:[(0,a.jsx)("p",{className:"text-sm text-slate-600",children:"長度（公分）"}),(0,a.jsxs)("p",{className:"text-2xl font-bold text-slate-900",children:[l.lengthCm.toFixed(2)," cm"]}),(0,a.jsxs)("p",{className:"mt-2 text-xs text-slate-500",children:["即時擷取：",l.liveCaptured?"是":"否"," \xb7 PPM：",l.ppm.toFixed(1)]})]}),(0,a.jsxs)("div",{className:"flex gap-3",children:[(0,a.jsx)("button",{type:"button",onClick:()=>n("camera"),className:"rounded-lg border border-slate-300 px-4 py-2 text-sm text-slate-700 hover:bg-slate-50",children:"重新拍攝"}),(0,a.jsx)("button",{type:"button",onClick:O,disabled:!k,className:"inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-4 py-2 text-sm text-white hover:bg-indigo-700 disabled:opacity-50",children:k?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(g.Z,{className:"h-4 w-4"}),"進行身分驗證"]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(f.Z,{className:"h-4 w-4 animate-spin"}),"載入驗證…"]})})]}),S&&(0,a.jsx)("p",{className:"mt-2 text-sm text-amber-600",children:S})]}),"verify"===t&&(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-6 shadow-sm",children:[(0,a.jsxs)("h2",{className:"mb-4 flex items-center gap-2 text-lg font-semibold",children:[(0,a.jsx)("span",{children:"步驟 3"})," 身分驗證 (Persona)"]}),(0,a.jsx)("p",{className:"mb-4 text-sm text-slate-600",children:"請在彈窗中完成政府證件與人臉掃描。完成後將自動進入證書步驟。"}),(0,a.jsx)("button",{type:"button",onClick:E,className:"rounded-lg bg-indigo-600 px-4 py-2 text-sm text-white hover:bg-indigo-700",children:"再次開啟驗證"})]}),"cert"===t&&l&&(0,a.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-white p-6 shadow-sm",children:[(0,a.jsxs)("h2",{className:"mb-4 flex items-center gap-2 text-lg font-semibold",children:[(0,a.jsx)("span",{children:"步驟 4"})," 數位證書"]}),N&&(0,a.jsxs)("p",{className:"mb-4 text-sm text-slate-600",children:["身分驗證 ID：",(0,a.jsx)("code",{className:"rounded bg-slate-100 px-1",children:N})]}),I?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"mb-4 rounded-lg bg-emerald-50 p-4",children:(0,a.jsxs)("p",{className:"flex items-center gap-2 text-emerald-800",children:[(0,a.jsx)(v.Z,{className:"h-5 w-5"}),"可下載數位認證證書（後端簽名）"]})}),R&&(0,a.jsx)("p",{className:"mb-2 text-sm text-red-600",children:R}),(0,a.jsxs)("button",{type:"button",onClick:U,className:"inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700",children:[(0,a.jsx)(j.Z,{className:"h-4 w-4"}),"下載證書 JSON"]})]}):(0,a.jsxs)("div",{className:"rounded-lg bg-amber-50 p-4 text-amber-800",children:[(0,a.jsx)("p",{className:"mb-2",children:"請先登入後再下載證書。"}),(0,a.jsx)(y.default,{href:"/login",className:"text-sm font-medium underline",children:"前往登入"})]})]})]})]})}},96264:function(e,t,n){"use strict";n.d(t,{$F:function(){return s},EN:function(){return r},mv:function(){return l},ys:function(){return i}});let a=n(20357).env.NEXT_PUBLIC_API_URL||"http://localhost:8080";async function s(e,t,n){let s=await fetch("".concat(a,"/api/certificates"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({inquiryId:t,measurement:n})});if(!s.ok)throw Error((await s.json().catch(()=>({}))).error||s.statusText);return s.json()}async function r(e){let t=await fetch("".concat(a,"/api/certificates"),{headers:{Authorization:"Bearer ".concat(e)}});if(!t.ok)throw Error(t.statusText);return t.json()}async function l(e,t){let n=await fetch("".concat(a,"/api/certificates/").concat(t),{headers:{Authorization:"Bearer ".concat(e)}});if(!n.ok)throw Error(n.statusText);return n.json()}async function i(e){let t=await fetch("".concat(a,"/api/certificates/verify"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error(t.statusText);return t.json()}},59941:function(e,t,n){"use strict";function a(e){let t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download="certification-".concat(e.inquiryId,"-").concat(Date.now(),".json"),a.click(),URL.revokeObjectURL(n)}n.d(t,{cP:function(){return a}})},6881:function(e,t,n){"use strict";n.d(t,{S:function(){return d}});var a,s,r=n(17327),l=n(20357);let i=null!==(a=l.env.NEXT_PUBLIC_SUPABASE_URL)&&void 0!==a?a:"",c=null!==(s=l.env.NEXT_PUBLIC_SUPABASE_ANON_KEY)&&void 0!==s?s:"",o=null;function d(){return o||(o=(0,r.eI)(i||"https://placeholder.supabase.co",c||"placeholder")),o}},48652:function(e,t,n){"use strict";n.d(t,{a:function(){return r}});var a=n(2265),s=n(6881);function r(){var e;let[t,n]=(0,a.useState)(null),[r,l]=(0,a.useState)(!0),i=(0,s.S)();return(0,a.useEffect)(()=>{i.auth.getSession().then(e=>{let{data:{session:t}}=e;n(t),l(!1)});let{data:{subscription:e}}=i.auth.onAuthStateChange((e,t)=>{n(t)});return()=>e.unsubscribe()},[i.auth]),{session:t,loading:r,accessToken:null!==(e=null==t?void 0:t.access_token)&&void 0!==e?e:null}}}},function(e){e.O(0,[425,399,663,566,636,938,498,349,327,391,971,23,744],function(){return e(e.s=66058)}),_N_E=e.O()}]);